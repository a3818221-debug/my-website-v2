// live-cricket.js ‚Äî Premium Live Cricket (single file)
// Run:  node -v  (>=18 hona chahiye)
//       npm init -y && npm install express
//       node live-cricket.js
// Open: http://localhost:3000

const express = require("express");
const app = express();
const PORT = process.env.PORT || 3000;

// ==== üîë YOUR RAPIDAPI KEY (server-side only) ====
// (Agar chaho to env var use karo: RAPIDAPI_KEY=... node live-cricket.js)
const API_KEY = process.env.RAPIDAPI_KEY || "ebe68114femsh3a16de60d6719ecp175bf8jsn01e67d4b7543";

// Common fetch helper
async function rapi(path) {
  const url = `https://cricbuzz-cricket.p.rapidapi.com${path}`;
  const r = await fetch(url, {
    headers: {
      "x-rapidapi-host": "cricbuzz-cricket.p.rapidapi.com",
      "x-rapidapi-key": API_KEY,
      "User-Agent": "Mozilla/5.0"
    }
  });
  if (!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}

// ===== API (server ‚Üí RapidAPI ‚Üí client) =====
app.get("/api/live", async (_req, res) => {
  try {
    const data = await rapi("/matches/v1/live");
    res.json(data);
  } catch (e) {
    res.status(500).json({ error: "live_failed", msg: e.message });
  }
});

// optional: per-match scorecard (try; UI gracefully degrades if not available)
app.get("/api/scorecard/:id", async (req, res) => {
  try {
    const id = req.params.id;
    const data = await rapi(`/mcenter/v1/${id}/scard`);
    res.json(data);
  } catch (e) {
    res.status(500).json({ error: "scard_failed", msg: e.message });
  }
});

// ====== FRONTEND (premium UI) ======
app.get("/", (_req, res) => {
  res.setHeader("Cache-Control", "no-cache");
  res.send(`<!doctype html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>üèè Live Cricket ‚Äî Fast & Clean</title>
<meta name="description" content="Live cricket scores ‚Äî fast, clean UI. Multi-match cards, Hindi/English, dark/light, auto-refresh."/>
<link rel="manifest" href="/manifest.webmanifest"/>
<link rel="icon" href="/icon.svg" type="image/svg+xml"/>
<meta name="theme-color" content="#0b1220"/>
<style>
:root{
  --bg:#0b1220; --card:#101a2c; --muted:#93a1b5; --text:#eaf1ff; --accent:#41a4ff; --ring:rgba(65,164,255,.35);
  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --brd:rgba(255,255,255,.09);
}
html[data-theme=light]{
  --bg:#f4f7ff; --card:#ffffff; --muted:#56627a; --text:#0b1220; --accent:#1a72ff; --ring:rgba(26,114,255,.35);
  --good:#15803d; --warn:#b45309; --bad:#b91c1c; --brd:rgba(12,24,48,.12);
}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;background:linear-gradient(135deg,var(--bg),#0f1732);color:var(--text)}
header{position:sticky;top:0;z-index:5;backdrop-filter:blur(10px);background:color-mix(in oklab,var(--bg) 85%, transparent);border-bottom:1px solid var(--brd);display:flex;gap:10px;align-items:center;padding:12px 16px}
h1{margin:0;font-size:18px;letter-spacing:.3px;display:flex;gap:8px;align-items:center}
.controls{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
button{background:transparent;color:var(--text);border:1px solid color-mix(in oklab,var(--text) 22%, transparent);padding:8px 10px;border-radius:10px;cursor:pointer}
button:hover{border-color:var(--accent)}
input[type=number]{width:92px;padding:6px 8px;border-radius:8px;border:1px solid var(--brd);background:transparent;color:var(--text)}
.container{max-width:1100px;margin:0 auto;padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.card{background:var(--card);border:1px solid var(--brd);border-radius:16px;padding:14px;box-shadow:0 12px 30px rgba(0,0,0,.14)}
.meta{font-size:12px;color:var(--muted)}
.title{font-weight:800;font-size:15px;margin-bottom:6px}
.badge{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--ring);color:var(--accent);background:color-mix(in oklab,var(--accent) 12%, transparent);display:inline-flex;align-items:center;gap:6px}
.live{display:inline-flex;align-items:center;gap:6px}
.dot{width:8px;height:8px;border-radius:50%;background:#ef4444;box-shadow:0 0 0 0 rgba(239,68,68,.7);animation:pulse 1.5s infinite}
@keyframes pulse{to{box-shadow:0 0 0 12px rgba(239,68,68,0)}}
.toprow{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:6px}
.score{font-size:22px;font-weight:800}
.small{font-size:12px;color:var(--muted)}
.tabbar{display:flex;gap:8px;flex-wrap:wrap;margin:12px 0}
.tab{padding:6px 10px;border:1px solid var(--brd);border-radius:999px;background:color-mix(in oklab,var(--accent) 8%, var(--card));cursor:pointer}
.tab.active{outline:2px solid var(--ring)}
#detail{display:none}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{padding:8px;border-bottom:1px dashed var(--brd);text-align:left}
th{color:var(--muted)}
.ad{display:grid;place-items:center;min-height:120px;border:1px dashed var(--brd);border-radius:14px;background:color-mix(in oklab,var(--accent) 6%, var(--card));font-size:12px;color:var(--muted);margin-top:12px}
</style>
</head>
<body>
<header>
  <h1>üèè Live Cricket <span class="live"><span class="dot"></span>live</span></h1>
  <div class="controls">
    <button id="langBtn">üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä</button>
    <button id="themeBtn">üåì</button>
    <label class="small">‚è± <span data-i18n="interval">Interval</span> <input id="interval" type="number" min="3000" step="1000" value="7000"> ms</label>
    <button id="backBtn" style="display:none">‚¨Ö Back</button>
  </div>
</header>

<div class="container">
  <div id="list">
    <div class="grid" id="grid">Loading‚Ä¶</div>
    <div class="ad">Ad Slot ‚Äî place your ad code here</div>
  </div>

  <div id="detail">
    <div class="tabbar" id="tabs"></div>
    <div class="card" id="dCard"></div>
    <div class="ad">Ad Slot ‚Äî place your ad code here</div>
  </div>
</div>

<script>
let lang = localStorage.getItem('lang') || 'en';
const I18N = {
  en:{ interval:'Interval', back:'Back', no:'No live matches right now.' },
  hi:{ interval:'‡§á‡§Ç‡§ü‡§∞‡§µ‡§≤', back:'‡§µ‡§æ‡§™‡§∏', no:'‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à ‡§≤‡§æ‡§á‡§µ ‡§Æ‡•à‡§ö ‡§®‡§π‡•Ä‡§Ç ‡§ö‡§≤ ‡§∞‡§π‡§æ‡•§' }
};
function t(k){ return I18N[lang][k] || k; }
function applyLang(){
  document.querySelectorAll('[data-i18n]').forEach(el=>{ el.textContent = t(el.getAttribute('data-i18n')); });
  document.getElementById('langBtn').textContent = lang==='en'?'üåê ‡§π‡§ø‡§Ç‡§¶‡•Ä':'üåê English';
  document.getElementById('backBtn').textContent = '‚¨Ö ' + t('back');
}
function setTheme(next){
  const html=document.documentElement;
  if(next){ html.setAttribute('data-theme', next); localStorage.setItem('theme', next); return; }
  const saved=localStorage.getItem('theme'); if(saved) return html.setAttribute('data-theme', saved);
  html.setAttribute('data-theme', window.matchMedia('(prefers-color-scheme: light)').matches?'light':'dark');
}
setTheme(); applyLang();

const grid = document.getElementById('grid');
const listView = document.getElementById('list');
const detailView = document.getElementById('detail');
const backBtn = document.getElementById('backBtn');
const intervalInput = document.getElementById('interval');
let timer=null, UPDATE_MS=7000;
let openIds = []; // detail tabs
let currentId = null;

async function loadLive(){
  try{
    const res = await fetch('/api/live', {cache:'no-store'});
    const data = await res.json();
    renderList(data);
  }catch(e){
    grid.innerHTML = '<div class="card">'+(lang==='hi'?t('no'):'Failed to load')+'</div>';
  }
}

function renderList(data){
  const list=[];
  if(data?.typeMatches?.length){
    data.typeMatches.forEach(tm=>{
      (tm.seriesMatches||[]).forEach(sm=>{
        const wrap = sm.seriesAdWrapper;
        if(wrap?.matches?.length){
          wrap.matches.forEach(m=>{
            const mi=m.matchInfo||{}, ms=m.matchScore||{};
            const t1=mi.team1?.teamName||'Team A';
            const t2=mi.team2?.teamName||'Team B';
            const s1=ms.team1Score?.inngs1, s2=ms.team2Score?.inngs1;
            const score1 = s1 ? \`\${s1.runs}/\${s1.wickets} (\${s1.overs})\` : '-';
            const score2 = s2 ? \`\${s2.runs}/\${s2.wickets} (\${s2.overs})\` : '-';
            const id = mi.matchId;
            list.push(\`
              <div class="card" onclick="openMatch(\${id})">
                <div class="toprow">
                  <div class="title">\${t1} <span class="small">vs</span> \${t2}</div>
                  <span class="badge">\${mi.matchFormat} ‚Ä¢ \${mi.stateTitle||mi.status||'Live'}</span>
                </div>
                <div class="score">\${score1}</div>
                <div class="small">\${t1}</div>
                <div style="height:6px"></div>
                <div class="score">\${score2}</div>
                <div class="small">\${t2}</div>
                <div class="meta" style="margin-top:8px">\${mi.seriesName || ''} ‚Ä¢ \${mi.venueInfo?.ground || ''}</div>
              </div>\`);
          });
        }
      });
    });
  }
  grid.innerHTML = list.join('') || ('<div class="card">'+t('no')+'</div>');
}

async function openMatch(id){
  if(!openIds.includes(id)) openIds.push(id);
  currentId = id;
  listView.style.display='none';
  detailView.style.display='block';
  backBtn.style.display='inline-block';
  renderTabs();
  await loadDetail();
  restart();
}

function renderTabs(){
  const tabs = document.getElementById('tabs');
  tabs.innerHTML = openIds.map(i=>\`<div class="tab \${i===currentId?'active':''}" onclick="switchTab(\${i})">Match \${i}</div>\`).join('');
}

function switchTab(id){ currentId=id; renderTabs(); loadDetail(); }

async function loadDetail(){
  const dCard = document.getElementById('dCard');
  dCard.innerHTML = 'Loading‚Ä¶';
  // Try scorecard endpoint; if fails, fallback to live list filtered
  try{
    const r = await fetch('/api/scorecard/'+currentId, {cache:'no-store'});
    if(r.ok){
      const sc = await r.json();
      // Very defensive ‚Äî fields vary a lot across formats. We show summary nicely.
      const ms = sc?.matchHeader || {};
      const teams = (ms.team1?.name||'Team A') + ' vs ' + (ms.team2?.name||'Team B');
      const status = ms.statusText || ms.status || 'Live';
      const series = ms.seriesName || '';
      const venue = ms.venue?.name || '';
      const i1 = sc?.scoreCard?.[0];
      const i2 = sc?.scoreCard?.[1];
      function line(ix){
        if(!ix) return '-';
        const scs = ix.score?.split('/')||[];
        const ov = ix.overs || '';
        const team = ix.batTeamDetails?.batTeamName || '';
        return \`<div class="score">\${ix.score || '-'} (\${ov})</div><div class="small">\${team}</div>\`;
      }
      dCard.innerHTML = \`
        <div class="toprow">
          <div class="title">\${teams}</div>
          <span class="badge">\${ms.matchFormat || ''} ‚Ä¢ \${status}</span>
        </div>
        \${line(i1)}
        <div style="height:6px"></div>
        \${line(i2)}
        <div class="meta" style="margin-top:8px">\${series} ‚Ä¢ \${venue}</div>
      \`;
      return;
    }
    throw new Error('scard not ok');
  }catch(_){
    // fallback: reload live and pick this id
    try{
      const live = await (await fetch('/api/live', {cache:'no-store'})).json();
      let card = null;
      live?.typeMatches?.forEach(tm=>{
        (tm.seriesMatches||[]).forEach(sm=>{
          const wrap=sm.seriesAdWrapper;
          (wrap?.matches||[]).forEach(m=>{
            if(m.matchInfo?.matchId==currentId) card = m;
          });
        });
      });
      if(card){
        const mi=card.matchInfo, ms=card.matchScore||{};
        const t1=mi.team1?.teamName||'Team A', t2=mi.team2?.teamName||'Team B';
        const s1=ms.team1Score?.inngs1, s2=ms.team2Score?.inngs1;
        const score1 = s1 ? \`\${s1.runs}/\${s1.wickets} (\${s1.overs})\` : '-';
        const score2 = s2 ? \`\${s2.runs}/\${s2.wickets} (\${s2.overs})\` : '-';
        dCard.innerHTML = \`
          <div class="toprow">
            <div class="title">\${t1} vs \${t2}</div>
            <span class="badge">\${mi.matchFormat} ‚Ä¢ \${mi.stateTitle||mi.status||'Live'}</span>
          </div>
          <div class="score">\${score1}</div><div class="small">\${t1}</div>
          <div style="height:6px"></div>
          <div class="score">\${score2}</div><div class="small">\${t2}</div>
          <div class="meta" style="margin-top:8px">\${mi.seriesName||''} ‚Ä¢ \${mi.venueInfo?.ground||''}</div>\`;
      }else{
        dCard.innerHTML = 'Not found';
      }
    }catch(e){
      dCard.innerHTML = 'Failed to load';
    }
  }
}

function restart(){ if(timer) clearInterval(timer); UPDATE_MS=Math.max(3000, parseInt(intervalInput.value||'7000',10)); timer = setInterval(()=>{ if(currentId) loadDetail(); else loadLive(); }, UPDATE_MS); }

document.getElementById('themeBtn').onclick = ()=> {
  const html=document.documentElement;
  const next = html.getAttribute('data-theme')==='dark'?'light':'dark';
  html.setAttribute('data-theme', next);
  localStorage.setItem('theme', next);
};
document.getElementById('langBtn').onclick = ()=>{ lang = (lang==='en'?'hi':'en'); localStorage.setItem('lang', lang); applyLang(); };
document.getElementById('backBtn').onclick = ()=>{ detailView.style.display='none'; listView.style.display='block'; backBtn.style.display='none'; currentId=null; restart(); };
intervalInput.onchange = ()=> restart();

loadLive(); restart();

// PWA register
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('/sw.js').catch(()=>{})); }
</script>
</body>
</html>`);
});

// PWA minimal
app.get("/manifest.webmanifest", (_req,res)=>{
  res.setHeader("Content-Type","application/manifest+json");
  res.send(JSON.stringify({
    name:"Live Cricket", short_name:"Cricket",
    start_url:"/", display:"standalone",
    background_color:"#0b1220", theme_color:"#0b1220",
    icons:[{src:"/icon.svg",sizes:"512x512",type:"image/svg+xml",purpose:"any maskable"}]
  }));
});
app.get("/icon.svg", (_req,res)=>{
  res.setHeader("Content-Type","image/svg+xml");
  res.send(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 128 128'>
  <defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop stop-color='#41a4ff'/><stop offset='1' stop-color='#0047ff'/></linearGradient></defs>
  <rect width='128' height='128' rx='24' fill='url(#g)'/>
  <circle cx='44' cy='64' r='16' fill='white' opacity='.9'/>
  <rect x='66' y='56' width='34' height='6' rx='3' fill='white'/>
  <rect x='66' y='70' width='34' height='6' rx='3' fill='white' opacity='.85'/>
</svg>`);
});
app.get("/sw.js", (_req,res)=>{
  res.setHeader("Content-Type","application/javascript");
  res.send(`self.addEventListener('install',e=>{e.waitUntil(caches.open('cricket-shell-v1').then(c=>c.addAll(['/','/manifest.webmanifest','/icon.svg'])))});self.addEventListener('activate',e=>{e.waitUntil(self.clients.claim())});self.addEventListener('fetch',e=>{const u=new URL(e.request.url);if(u.pathname.startsWith('/api/'))return;e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request).then(resp=>{const cp=resp.clone();caches.open('cricket-shell-v1').then(c=>c.put(e.request,cp));return resp;})))})`);
});

// Start server
app.listen(PORT, () => console.log(`‚úÖ Live Cricket running on http://localhost:${PORT}`));
